---
phase: 03-hypothesis-synthesis
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - agents/grd-architect.md
autonomous: true

must_haves:
  truths:
    - "User receives clear error message when metric weights do not sum to 1.0"
    - "User receives warning when no baseline is defined (but can proceed)"
    - "User is prompted to fix validation errors before OBJECTIVE.md is generated"
    - "User sees data-informed warnings when evaluation methodology conflicts with data characteristics"
  artifacts:
    - path: "agents/grd-architect.md"
      provides: "Validation logic embedded in agent Step 6"
      contains: "validate"
  key_links:
    - from: "agents/grd-architect.md"
      to: ".planning/OBJECTIVE.md"
      via: "validation before write"
      pattern: "validate.*before"
---

<objective>
Add comprehensive validation logic and baseline warning system to the grd-architect agent.

Purpose: Ensure OBJECTIVE.md documents meet quality standards before generation. Validate metric weights, evaluation methodology compatibility, and enforce baseline soft gate.

Output: Enhanced validation in `agents/grd-architect.md` Step 6
</objective>

<execution_context>
@/Users/evanowen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/evanowen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-hypothesis-synthesis/03-CONTEXT.md
@.planning/phases/03-hypothesis-synthesis/03-RESEARCH.md
@.planning/phases/03-hypothesis-synthesis/03-01-SUMMARY.md
@.planning/phases/03-hypothesis-synthesis/03-02-SUMMARY.md

# Reference for agent update
@agents/grd-architect.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validation logic to grd-architect agent</name>
  <files>agents/grd-architect.md</files>
  <action>
Enhance Step 6 (Validate Completeness) in grd-architect.md with comprehensive validation logic.

**Validation is implemented as inline guidance for the agent** - not as executable Python code, but as pseudocode/logic the agent follows when executing Step 6. The agent applies these rules using its reasoning capabilities.

**Add validation subsections to Step 6:**

### 6.1 Hypothesis Completeness Validation

Check required elements are present and non-empty:

**Logic the agent follows:**
- Hypothesis statement must be at least 20 characters
- Expected outcome must be specified
- At least one success metric must be defined
- Evaluation methodology must be specified
- At least one falsification criterion must be present
- Context section should have substantial content (warn if short)

**Error handling:**
- Missing required elements = ERROR (block generation, ask user to fix)
- Short context = WARNING (allow proceeding)

### 6.2 Metric Weight Validation

Ensure weights sum to 1.0 with tolerance:

**Logic the agent follows:**
- Sum all metric weights
- If |sum - 1.0| > 0.01: ERROR "Metric weights sum to {sum}, should be 1.0"
- Check each weight is between 0 and 1
- Invalid weight = ERROR

**Present to user:**
```
ERROR: Metric weights sum to 0.8, should be 1.0

Current metrics:
- Accuracy: 0.5
- F1: 0.3

Please adjust weights to sum to 1.0.
```

### 6.3 Evaluation Methodology Validation

Check methodology is appropriate for task:

**Logic the agent follows:**
- Valid strategies: k-fold, stratified-k-fold, time-series-split, holdout
- If k-fold: k must be >= 2, warn if k > 20
- If holdout: test_size should be between 0.1 and 0.5
- If data has datetime columns (from DATA_REPORT.md) and strategy is not time-series-split: WARN about potential temporal leakage

**Present to user:**
```
WARNING: Data has datetime columns but using k-fold.
Consider time-series-split to avoid temporal leakage.

Continue anyway? (yes/no)
```

### 6.4 Baseline Soft Gate

Implement baseline warning system:

**Logic the agent follows:**
- If baselines array is empty or not defined:
  - WARN: "No baseline defined. Cannot claim improvement without comparison point."
  - Present options: own implementation, literature citation, random/majority baseline
  - Ask: "Continue without baseline? (You can add one later)"
  - User says yes: proceed with warning noted
  - User says no: ask for baseline definition
- This is a SOFT GATE - warns but does NOT block

**Present to user:**
```
WARNING: No baseline defined.

Without a baseline, you cannot claim your model "improves" anything.

Options:
1. Run your own baseline (e.g., logistic regression, decision tree)
2. Cite literature baseline for this task/dataset
3. Establish random/majority-class baseline for lower bound

Continue without baseline? (yes/no)
```

### 6.5 Falsification Criteria Validation

Ensure criteria are meaningful:

**Logic the agent follows:**
- At least one falsification criterion required (ERROR if missing)
- Criterion metrics should match defined success metrics (WARN if mismatch)
- Quantitative criteria should have thresholds (WARN if missing)
- All criteria should have explanations (WARN if missing)
- If only qualitative criteria: WARN "Consider adding quantitative criteria for objectivity"

### 6.6 Full Validation Orchestration

Combine all validations and present to user:

**Order of operations:**
1. Run all validations, collect errors and warnings
2. If errors exist: Present errors, ask user to fix, do NOT proceed to Step 7
3. If only warnings: Present warnings, ask user to confirm proceeding
4. If clean: Proceed directly to Step 7

**Present validation results:**
```
## Validation Results

### Errors (must fix before proceeding)
{errors_list or "None"}

### Warnings (review recommended)
{warnings_list or "None"}

### Baseline Status
{baseline_status_message}
{baseline_recommendations if applicable}

---

{if errors}
Please address the errors above before proceeding.
{ask for corrections via AskUserQuestion}

{else if warnings}
Proceed with OBJECTIVE.md generation? (yes/no)

{else}
All validations passed. Generating OBJECTIVE.md...
```

**Important:** Baseline missing is a WARNING only. User can proceed. All other validation failures (metric weights, missing required fields) are ERRORS that must be fixed.
  </action>
  <verify>
File updated: `grep "validate" agents/grd-architect.md`
Contains weight validation: `grep -i "weight.*sum\|sum.*1.0" agents/grd-architect.md`
Contains baseline soft gate: `grep -i "soft.gate\|WARNING.*baseline" agents/grd-architect.md`
Contains evaluation validation: `grep "time-series-split" agents/grd-architect.md`
Contains error vs warning distinction: `grep -i "must fix\|Errors.*must" agents/grd-architect.md`
  </verify>
  <done>
grd-architect agent enhanced with validation logic:
- Hypothesis completeness validation (required elements)
- Metric weight validation (sum to 1.0) - ERROR if invalid
- Evaluation methodology validation (appropriate for task) - WARN if concerns
- Baseline soft gate (warns but allows proceeding) - WARNING only
- Falsification criteria validation (meaningful criteria)
- Validation orchestration: errors block, warnings allow proceeding with confirmation
  </done>
</task>

<task type="auto">
  <name>Task 2: Add data constraints integration</name>
  <files>agents/grd-architect.md</files>
  <action>
Enhance Step 1 (Load Context) to extract data constraints from DATA_REPORT.md and integrate into validation.

**Add to Step 1:**

### 1.3 Extract Data Characteristics for Validation

If DATA_REPORT.md exists, extract characteristics that affect validation:

**Characteristics to extract (as agent guidance):**
- `has_datetime_columns`: Look for datetime column indicators in DATA_REPORT.md
- `has_class_imbalance`: Look for class balance section, note severity
- `leakage_warnings`: Extract HIGH confidence leakage indicators
- `missing_data_columns`: Note columns with significant missing data
- `sample_size`: Extract row count for sample size considerations

**How to extract (agent guidance):**
- Read DATA_REPORT.md
- Look for "## Class Balance" section - note any imbalance
- Look for "## Leakage Analysis" section - extract HIGH confidence warnings
- Look for "## Missing Data" section - note problematic columns
- Look for "Shape:" or "Rows:" to get sample size

**Add to Step 6:**

Pass data characteristics to validation logic:

**Data-informed warnings:**
- If class imbalance is HIGH and user selects "accuracy" as metric:
  - WARN: "High class imbalance detected. Consider using F1, precision/recall, or AUC instead of accuracy."
- If leakage warnings exist with HIGH confidence:
  - WARN: "DATA_REPORT.md flagged potential leakage in feature '{feature}'. Exclude from hypothesis if using this feature."
- If datetime columns exist and evaluation is not time-series-split:
  - WARN: "Data has temporal features. Consider time-series-split to avoid temporal leakage."

**Add constraint section to OBJECTIVE.md:**

If data constraints exist, automatically populate Constraints section:

**Auto-generated constraints:**
- Class imbalance: "Class imbalance ({severity}): Consider stratified sampling or class weights"
- Leakage features: "Exclude feature '{feature}' due to potential leakage (confidence: HIGH)"
- Missing data: "Handle missing data in: {columns}"

These constraints are added to OBJECTIVE.md automatically based on DATA_REPORT.md findings.
  </action>
  <verify>
Contains data characteristics extraction: `grep -i "extract.*characteristics\|DATA_REPORT" agents/grd-architect.md`
Contains class imbalance warning: `grep -i "class.imbalance\|imbalance" agents/grd-architect.md`
Contains leakage integration: `grep -i "leakage" agents/grd-architect.md`
Contains constraints generation: `grep -i "constraint" agents/grd-architect.md`
  </verify>
  <done>
grd-architect agent enhanced with data constraints integration:
- DATA_REPORT.md characteristics extraction guidance
- Data-informed validation warnings
- Automatic constraints section population
- Leakage feature warnings
- Class imbalance metric recommendations
  </done>
</task>

</tasks>

<verification>
- [ ] Validation logic added to Step 6 of grd-architect agent
- [ ] Metric weights validated to sum to 1.0 (ERROR if invalid)
- [ ] Baseline soft gate issues warning (not error) when missing
- [ ] Evaluation methodology validated for task type
- [ ] Falsification criteria validated for meaningfulness
- [ ] Data characteristics extracted from DATA_REPORT.md
- [ ] Constraints auto-populated from data characteristics
- [ ] Validation wiring is inline agent guidance, not executable code
</verification>

<success_criteria>
OBJECTIVE.md generation is guarded by comprehensive validation. Users receive clear feedback on errors (must fix) vs warnings (review recommended). Baseline missing is a soft gate that warns but allows proceeding.
</success_criteria>

<output>
After completion, create `.planning/phases/03-hypothesis-synthesis/03-03-SUMMARY.md`
</output>
