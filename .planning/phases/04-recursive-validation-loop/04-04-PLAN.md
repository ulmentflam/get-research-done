---
phase: 04-recursive-validation-loop
plan: 04
type: execute
wave: 2
depends_on: ["04-01", "04-02", "04-03"]
files_modified:
  - agents/grd-researcher.md
  - commands/grd/research.md
  - get-research-done/templates/state.md
autonomous: true

must_haves:
  truths:
    - "Loop routes correctly: PROCEED->Evaluator, REVISE_METHOD->Researcher, REVISE_DATA->Explorer"
    - "Iteration limit (default 5) triggers human decision gate"
    - "STATE.md tracks current iteration and loop history"
  artifacts:
    - path: "agents/grd-researcher.md"
      provides: "Updated Researcher with loop orchestration"
      contains: "iteration_limit"
    - path: "commands/grd/research.md"
      provides: "Updated command with iteration tracking"
      contains: "iteration"
    - path: "get-research-done/templates/state.md"
      provides: "STATE.md template with loop tracking fields"
      contains: "loop_history"
  key_links:
    - from: "agents/grd-researcher.md"
      to: "agents/grd-critic.md"
      via: "Task spawn"
      pattern: "grd-critic"
    - from: "agents/grd-researcher.md"
      to: "agents/grd-evaluator.md"
      via: "Task spawn on PROCEED verdict"
      pattern: "grd-evaluator"
    - from: "agents/grd-researcher.md"
      to: "commands/grd/explore.md"
      via: "route on REVISE_DATA verdict"
      pattern: "explore"
---

<objective>

Wire the recursive validation loop by integrating Researcher, Critic, and Evaluator with proper routing and iteration limits.

Purpose: This plan connects the three agents (created in Wave 1) into a functioning loop with conditional routing based on Critic verdicts, iteration tracking, and human-in-the-loop gates when limits are reached.

Output:
- Updated Researcher agent with full loop orchestration
- Updated research command with iteration handling
- Updated STATE.md template with loop tracking

</objective>

<execution_context>

@/Users/evanowen/.claude/get-research-done/workflows/execute-plan.md
@/Users/evanowen/.claude/get-research-done/templates/summary.md

</execution_context>

<context>

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-recursive-validation-loop/04-CONTEXT.md
@.planning/phases/04-recursive-validation-loop/04-RESEARCH.md

Reference files from Wave 1:
@commands/grd/research.md
@agents/grd-researcher.md
@agents/grd-critic.md
@agents/grd-evaluator.md

Reference existing patterns:
@commands/grd/explore.md
@get-research-done/templates/state.md

</context>

<tasks>

<task type="auto">
  <name>Task 1: Add loop orchestration to grd-researcher</name>
  <files>agents/grd-researcher.md</files>
  <action>
Update the grd-researcher agent to include full loop orchestration logic.

Add new section after Step 7 (Spawn Critic):

**Step 7.5: Handle Critic Verdict Routing**

```markdown
### Routing Logic

Based on Critic verdict, route to appropriate next step:

**If PROCEED:**
1. Check Critic confidence level
2. If confidence == HIGH or MEDIUM:
   - Spawn grd-evaluator agent via Task
   - Pass: run directory, OBJECTIVE.md path, CRITIC_LOG path
   - Return success with SCORECARD.json path
3. If confidence == LOW:
   - Gate to human for confirmation
   - Present: metrics summary, Critic reasoning, recommendation
   - Human can: approve (continue to Evaluator), reject (REVISE_METHOD), escalate

**If REVISE_METHOD:**
1. Log CRITIC_LOG.md to run directory
2. Check iteration count against limit (default: 5)
3. If under limit:
   - Archive current run (move to experiments/archive/)
   - Increment iteration count
   - Return to Step 2 (Create Run Directory) with new run number
   - Include Critic recommendations in context
4. If at limit:
   - Trigger human decision gate (Step 8)

**If REVISE_DATA:**
1. Log CRITIC_LOG.md with specific data concerns
2. Extract data issues from Critic recommendations
3. Route to /grd:explore with specific concerns:
   - Pass: concern list, original DATA_REPORT.md path
   - Explorer will append findings to DATA_REPORT.md
4. After Explorer completes:
   - User must re-run /grd:research to continue loop
   - Or user can /grd:architect to reformulate hypothesis

**If ESCALATE:**
1. Prepare evidence package:
   - All CRITIC_LOGs from this hypothesis
   - Metrics trend across iterations
   - Current run artifacts
2. Surface to human for strategic decision
3. Human options: Continue, Archive, Reset, Escalate
```

Add new Step 8 (or update existing):

**Step 8: Human Decision Gate**

```markdown
### Human Gate (at iteration limit or ESCALATE)

When iteration limit reached or Critic ESCALATE:

1. Prepare evidence package:
   - Iterations completed: N
   - Verdict history: [REVISE_METHOD, REVISE_METHOD, REVISE_DATA, ...]
   - Metric trend: improving / stagnant / degrading
   - Latest critique summary
   - Cost estimate (if available)

2. Present options using AskUserQuestion:
   - **Continue**: Allow more iterations (resets limit)
   - **Archive**: Move all runs to archive/, mark hypothesis as abandoned
   - **Reset**: Archive runs, start fresh approach (new run_001)
   - **Escalate**: Return to /grd:architect to reformulate hypothesis

3. Log human decision:
   - Write HUMAN_DECISION.md to latest run directory
   - Include timestamp, decision, rationale (if provided)

4. Execute decision:
   - Continue: increment limit, return to Step 2
   - Archive: move runs, return completion with "archived" status
   - Reset: archive, return with instruction to re-run /grd:research
   - Escalate: return with instruction to run /grd:architect
```

Add iteration tracking variables at top of agent:

```markdown
### Internal State

Track across iterations:
- iteration_count: Current iteration number (starts at 1)
- iteration_limit: Maximum allowed iterations (default: 5, configurable)
- verdict_history: List of Critic verdicts for trend detection
- metrics_history: Metrics from each iteration for trend analysis
```

Add cycle detection:

```markdown
### Cycle Detection

If same verdict 3 times in a row with similar Critic feedback:
- Log warning: "Potential cycle detected"
- Force ESCALATE to human even if under iteration limit
- Present: repeated verdicts, Critic recommendations not being addressed
```
  </action>
  <verify>
```bash
# Check updated agent has loop orchestration
grep -q "REVISE_METHOD" agents/grd-researcher.md && echo "Has REVISE_METHOD routing"
grep -q "REVISE_DATA" agents/grd-researcher.md && echo "Has REVISE_DATA routing"
grep -q "grd-evaluator" agents/grd-researcher.md && echo "Spawns Evaluator"
grep -q "iteration_limit" agents/grd-researcher.md && echo "Has iteration limit"
grep -q "Human" agents/grd-researcher.md && echo "Has human gate"
grep -q "archive" agents/grd-researcher.md && echo "Has archive logic"
grep -q "cycle" agents/grd-researcher.md && echo "Has cycle detection"
```
  </verify>
  <done>Agent updated with full routing logic for all four verdicts, iteration limit enforcement, human decision gate, and cycle detection</done>
</task>

<task type="auto">
  <name>Task 2: Update research command with iteration handling</name>
  <files>commands/grd/research.md</files>
  <action>
Update the /grd:research command to handle iteration state.

Add to arguments section:

```markdown
**Arguments:**

`[description]` (optional)
- One-line description for run naming
- Examples: "baseline", "lr_sweep", "feature_engineering"
- If omitted, uses "experiment"

**Flags:**

`--continue`
- Continue from previous run after REVISE_METHOD verdict
- Loads latest CRITIC_LOG.md recommendations
- Increments iteration count

`--iteration N`
- Manually specify iteration number
- Useful for resuming after interruption

`--limit N`
- Override default iteration limit (default: 5)
- Use with caution - higher limits increase cost

`--from-archive RUN_NAME`
- Restore archived run and continue from there
- Moves run back to experiments/
```

Update Phase 1 (Setup) to include:

```markdown
## Phase 1: Setup and State Loading

**Check OBJECTIVE.md exists (hard gate):**
\`\`\`bash
[ ! -f .planning/OBJECTIVE.md ] && echo "ERROR: No OBJECTIVE.md found. Run /grd:architect first." && exit 1
\`\`\`

**Determine iteration state:**

If `--continue` flag:
- Find latest run directory in experiments/
- Read CRITIC_LOG.md for verdict and recommendations
- If verdict != REVISE_METHOD: warn "No REVISE_METHOD to continue from"
- Set iteration_count from previous run + 1

If `--iteration N`:
- Use provided N as iteration_count
- Warn if N conflicts with existing runs

Otherwise (fresh start):
- Set iteration_count = 1
- Scan experiments/ for existing runs to determine next run number

**Load iteration limit:**
- Default: 5
- Override with `--limit N` if provided
- Log: "Iteration limit: N"

**Update STATE.md:**
- Set current_phase: "research"
- Set current_iteration: N
- Set active_hypothesis: (from OBJECTIVE.md)
```

Update Phase 3 to handle loop completion:

```markdown
## Phase 3: Handle Loop Completion

After Researcher returns:

**If PROCEED + Evaluator complete:**
- Display SCORECARD.json summary
- Log: "Experiment validated. Ready for Phase 5 human review."
- Update STATE.md: status = "pending_human_review"

**If iteration limit reached:**
- Display human decision prompt
- Log decision to STATE.md
- Update STATE.md: status = "human_decision_required"

**If REVISE_DATA:**
- Display data concerns from Critic
- Log: "Routing to /grd:explore for data re-verification"
- Provide command: `/grd:explore --concerns "..."`
- Update STATE.md: status = "data_verification_required"

**If archived/reset:**
- Update STATE.md: status = "archived" or "reset"
- Provide next steps guidance
```
  </action>
  <verify>
```bash
# Check command has iteration handling
grep -q "\-\-continue" commands/grd/research.md && echo "Has --continue flag"
grep -q "\-\-iteration" commands/grd/research.md && echo "Has --iteration flag"
grep -q "\-\-limit" commands/grd/research.md && echo "Has --limit flag"
grep -q "iteration_count" commands/grd/research.md && echo "Has iteration tracking"
grep -q "STATE.md" commands/grd/research.md && echo "Updates STATE.md"
```
  </verify>
  <done>Command updated with --continue, --iteration, --limit flags, iteration state loading, and STATE.md updates for loop tracking</done>
</task>

<task type="auto">
  <name>Task 3: Update STATE.md template with loop tracking</name>
  <files>get-research-done/templates/state.md</files>
  <action>
Update the STATE.md template to include loop tracking fields.

Read current template first, then add new section after "Current Position":

```markdown
## Research Loop State

**Active Hypothesis:** {{hypothesis_id_or_none}}
**Objective:** {{brief_hypothesis_statement}}
**Status:** {{not_started|in_progress|pending_review|archived}}

### Current Iteration

- **Iteration:** {{N}} of {{limit}} (default limit: 5)
- **Current Run:** experiments/{{run_NNN_description}}
- **Phase:** {{researcher|critic|evaluator|human_review}}

### Loop History

| Iteration | Run | Verdict | Confidence | Metrics Summary |
|-----------|-----|---------|------------|-----------------|
| 1 | run_001_baseline | REVISE_METHOD | MEDIUM | acc=0.72 |
| 2 | run_002_tuned | PROCEED | HIGH | acc=0.85 |

### Verdict Trend

- **Pattern:** {{improving|stagnant|degrading|mixed}}
- **Consecutive same verdicts:** {{N}}
- **Last 3 verdicts:** {{verdict1, verdict2, verdict3}}

### Human Decisions

| Timestamp | Decision | Rationale |
|-----------|----------|-----------|
| {{timestamp}} | {{Continue|Archive|Reset|Escalate}} | {{user_rationale}} |

### Data Revisions

If REVISE_DATA was triggered:

| Iteration | Concerns | Explorer Result |
|-----------|----------|-----------------|
| {{N}} | {{concern_list}} | {{DATA_REPORT_updated|no_change}} |
```

Also update the "Accumulated Context" section to track research decisions:

```markdown
### Research Decisions

| Decision | Iteration | Impact |
|----------|-----------|--------|
| {{decision_description}} | {{N}} | {{what_changed}} |
```

Add to "Blockers/Concerns" section:

```markdown
### Research Blockers

- **Current:** {{blocker_or_none}}
- **Requires:** {{human_action|data_fix|method_change}}
```
  </action>
  <verify>
```bash
# Check STATE.md template has loop tracking
grep -q "Research Loop State" get-research-done/templates/state.md && echo "Has Research Loop section"
grep -q "Current Iteration" get-research-done/templates/state.md && echo "Has iteration tracking"
grep -q "Loop History" get-research-done/templates/state.md && echo "Has loop history"
grep -q "Verdict Trend" get-research-done/templates/state.md && echo "Has verdict trend"
grep -q "Human Decisions" get-research-done/templates/state.md && echo "Has human decisions table"
```
  </verify>
  <done>STATE.md template updated with Research Loop State section including iteration tracking, loop history table, verdict trend analysis, human decisions log, and data revision tracking</done>
</task>

</tasks>

<verification>

After all tasks complete:
1. Researcher routes correctly based on all four verdicts
2. PROCEED spawns Evaluator (with confidence gate)
3. REVISE_METHOD loops back with iteration check
4. REVISE_DATA routes to Explorer with concerns
5. ESCALATE triggers human gate
6. Iteration limit enforced (default: 5)
7. Human decision gate works at limit
8. Cycle detection prevents infinite loops
9. STATE.md tracks full loop history
10. Command flags enable resume and continuation

</verification>

<success_criteria>

- [ ] Researcher has routing for PROCEED, REVISE_METHOD, REVISE_DATA, ESCALATE
- [ ] Researcher spawns Evaluator on PROCEED with HIGH/MEDIUM confidence
- [ ] Researcher gates to human on PROCEED with LOW confidence
- [ ] Researcher loops on REVISE_METHOD (under limit)
- [ ] Researcher routes to Explorer on REVISE_DATA
- [ ] Researcher triggers human gate at iteration limit
- [ ] Cycle detection prevents 3+ identical verdicts
- [ ] Command has --continue, --iteration, --limit flags
- [ ] STATE.md tracks iteration count, history, and human decisions
- [ ] Archives failed/abandoned runs to experiments/archive/

</success_criteria>

<output>

After completion, create `.planning/phases/04-recursive-validation-loop/04-04-SUMMARY.md`

</output>
