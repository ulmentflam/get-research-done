---
phase: 06-notebook-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/grd/notebook_executor.py
  - src/grd/graduation_validator.py
  - src/grd/__init__.py
autonomous: true

must_haves:
  truths:
    - "Notebooks execute with fresh kernel per run"
    - "Cell-level timeouts catch infinite loops"
    - "Metrics extracted via scrapbook to structured files"
    - "Graduation validation detects missing random seeds"
    - "Graduation validation warns on hardcoded paths"
  artifacts:
    - path: "src/grd/notebook_executor.py"
      provides: "Papermill-based notebook execution with scrapbook output extraction"
      exports: ["execute_notebook_experiment"]
      min_lines: 80
    - path: "src/grd/graduation_validator.py"
      provides: "Notebook graduation checklist validation"
      exports: ["validate_graduation_requirements"]
      min_lines: 60
    - path: "src/grd/__init__.py"
      provides: "Package initialization"
  key_links:
    - from: "src/grd/notebook_executor.py"
      to: "papermill"
      via: "pm.execute_notebook()"
      pattern: "pm\\.execute_notebook"
    - from: "src/grd/notebook_executor.py"
      to: "scrapbook"
      via: "sb.read_notebook()"
      pattern: "sb\\.read_notebook"
    - from: "src/grd/graduation_validator.py"
      to: "nbformat"
      via: "nbformat.read()"
      pattern: "nbformat\\.read"
---

<objective>
Create Python modules for notebook execution and graduation validation infrastructure.

Purpose: Provide the execution engine that enables notebooks to run through GRD validation loop with full reproducibility (fresh kernel, cell timeouts, structured output extraction) and validate graduation requirements (seeds, paths, parameters).

Output:
- `src/grd/notebook_executor.py` - Execute notebooks via papermill, extract metrics via scrapbook
- `src/grd/graduation_validator.py` - Validate notebooks meet graduation checklist
- `src/grd/__init__.py` - Package initialization
</objective>

<execution_context>
@/Users/evanowen/.claude/get-research-done/workflows/execute-plan.md
@/Users/evanowen/.claude/get-research-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-notebook-support/06-CONTEXT.md
@.planning/phases/06-notebook-support/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notebook executor module</name>
  <files>src/grd/notebook_executor.py, src/grd/__init__.py</files>
  <action>
Create the `src/grd/` directory structure and notebook execution module.

**Create `src/grd/__init__.py`:**
```python
"""GRD Python utilities for notebook execution and graduation validation."""
from .notebook_executor import execute_notebook_experiment
from .graduation_validator import validate_graduation_requirements

__all__ = ['execute_notebook_experiment', 'validate_graduation_requirements']
```

**Create `src/grd/notebook_executor.py`:**

Implement based on RESEARCH.md code examples with these requirements:

1. **Function signature:**
   ```python
   def execute_notebook_experiment(
       notebook_path: str,
       run_dir: Path,
       parameters: dict,
       execution_timeout: int = 300,
       start_timeout: int = 60,
       retry_on_failure: bool = True
   ) -> dict
   ```

2. **Return value:** Dict with keys: `success`, `output_notebook`, `metrics`, `error`, `execution_time_seconds`

3. **Requirements from CONTEXT.md:**
   - Fresh kernel for every run (papermill handles this automatically)
   - Cell-level timeout (use execution_timeout parameter)
   - Auto-detect kernel from notebook metadata, fall back to None (current environment)
   - Retry once on execution failure before marking run as failed
   - Save both executed notebook AND extract outputs to structured files

4. **Validation:**
   - Raise ValueError if `random_seed` not in parameters (hard requirement per CONTEXT.md)
   - Create run_dir if not exists

5. **Output extraction:**
   - Use scrapbook to extract all glue() outputs
   - Save metrics to `run_dir/metrics.json`
   - Include execution_time_seconds in metrics

6. **Error handling:**
   - Catch PapermillExecutionError
   - On retry failure, still save partial notebook if exists
   - Return error message in result dict

7. **Imports required:**
   ```python
   import papermill as pm
   import scrapbook as sb
   from pathlib import Path
   import json
   import time
   ```

Do NOT implement container/isolation support (deferred per RESEARCH.md).
Do NOT implement checkpointing/resume (deferred per RESEARCH.md).
  </action>
  <verify>
Run: `python -c "from src.grd.notebook_executor import execute_notebook_experiment; print('Import OK')"`
Verify: No import errors (papermill, scrapbook must be available)
Check: Function has docstring, type hints, and handles all requirements
  </verify>
  <done>
- `src/grd/__init__.py` exports both functions
- `src/grd/notebook_executor.py` implements execute_notebook_experiment with papermill+scrapbook
- Function validates random_seed parameter
- Function saves metrics to JSON
- Retry logic implemented
  </done>
</task>

<task type="auto">
  <name>Task 2: Create graduation validator module</name>
  <files>src/grd/graduation_validator.py</files>
  <action>
Create graduation validation module based on RESEARCH.md code examples.

**Create `src/grd/graduation_validator.py`:**

1. **Function signature:**
   ```python
   def validate_graduation_requirements(notebook_path: str) -> dict
   ```

2. **Return value:** Dict with keys: `passed`, `errors`, `warnings`
   - `passed`: bool - True if all hard requirements met (no errors)
   - `errors`: list[str] - Blocking issues that prevent graduation
   - `warnings`: list[str] - Advisory issues (logged but don't block)

3. **Hard requirements (errors if missing):**
   - Random seed must be explicitly set (check for patterns: `random.seed(`, `np.random.seed(`, `torch.manual_seed(`, `random_seed =`)
   - Must have cell tagged with 'parameters' (check cell.metadata.tags for 'parameters')

4. **Advisory warnings (warnings if found):**
   - Hardcoded absolute paths: `/Users/`, `/home/`, `C:\\`, `~/`
   - Magic commands: lines starting with `%` or `%%` (will break in script)
   - Shell commands: lines starting with `!` (will break in script)

5. **Implementation per RESEARCH.md:**
   - Use nbformat to read notebook
   - Iterate cells checking source for patterns
   - Use regex for pattern matching

6. **Additional from CONTEXT.md:**
   - Tiered blocking: reproducibility checks block (seeds), style checks warn only (paths, magics)

**Imports required:**
```python
import re
from pathlib import Path
import nbformat
```
  </action>
  <verify>
Run: `python -c "from src.grd.graduation_validator import validate_graduation_requirements; print('Import OK')"`
Verify: No import errors (nbformat must be available)
Check: Function returns dict with passed, errors, warnings keys
  </verify>
  <done>
- `src/grd/graduation_validator.py` implements validate_graduation_requirements
- Hard requirements: random seed + parameters cell tag
- Advisory warnings: absolute paths, magic commands, shell commands
- Returns structured dict with passed/errors/warnings
  </done>
</task>

</tasks>

<verification>
1. Both modules importable: `python -c "from src.grd import execute_notebook_experiment, validate_graduation_requirements"`
2. Package structure exists: `ls src/grd/`
3. Functions have correct signatures and docstrings
</verification>

<success_criteria>
- src/grd/ package created with __init__.py
- notebook_executor.py implements execution with papermill+scrapbook
- graduation_validator.py implements graduation checklist
- Both functions importable from package
- No import errors with required dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/06-notebook-support/06-01-SUMMARY.md`
</output>
