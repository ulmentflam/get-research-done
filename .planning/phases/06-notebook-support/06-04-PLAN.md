---
phase: 06-notebook-support
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - commands/grd/graduate.md
  - agents/grd-graduator.md
autonomous: true

must_haves:
  truths:
    - "User can run /grd:graduate to convert validated notebook to script"
    - "Graduation validates notebook meets checklist requirements"
    - "Graduation requires Critic PROCEED verdict"
    - "Graduated script includes source notebook reference"
  artifacts:
    - path: "commands/grd/graduate.md"
      provides: "Command to graduate notebooks to validated scripts"
      contains: "PROCEED"
      min_lines: 80
    - path: "agents/grd-graduator.md"
      provides: "Agent that handles graduation workflow"
      exports: ["notebook-to-script conversion", "validation", "refactoring guidance"]
      min_lines: 150
  key_links:
    - from: "commands/grd/graduate.md"
      to: "agents/grd-graduator.md"
      via: "Task spawning"
      pattern: "grd-graduator"
    - from: "agents/grd-graduator.md"
      to: "src/grd/graduation_validator.py"
      via: "Import validate_graduation_requirements"
      pattern: "validate_graduation_requirements"
    - from: "agents/grd-graduator.md"
      to: "get-research-done/templates/graduated-script.md"
      via: "Template reference"
      pattern: "graduated-script"
---

<objective>
Create graduation command and agent to convert validated notebooks to production scripts.

Purpose: Enable explicit graduation path from exploratory notebooks (notebooks/exploration/) to validated scripts (src/experiments/) when notebooks achieve Critic PROCEED verdict, per NOTE-02 requirement.

Output:
- `commands/grd/graduate.md` - User command for graduation
- `agents/grd-graduator.md` - Agent handling graduation workflow
</objective>

<execution_context>
@/Users/evanowen/.claude/get-research-done/workflows/execute-plan.md
@/Users/evanowen/.claude/get-research-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-notebook-support/06-CONTEXT.md
@.planning/phases/06-notebook-support/06-RESEARCH.md
@.planning/phases/06-notebook-support/06-01-SUMMARY.md
@commands/grd/research.md
@agents/grd-researcher.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /grd:graduate command</name>
  <files>commands/grd/graduate.md</files>
  <action>
Create the graduation command following existing command patterns (see commands/grd/research.md).

**YAML frontmatter:**
```yaml
---
name: graduate
description: Graduate a validated notebook to a production Python script in src/experiments/
argument-hint: "<notebook_path> [--run <run_number>] [--name <script_name>]"
allowed-tools: [Read, Write, Bash, Glob, Grep, Task]
---
```

**Objective section:**
```xml
<objective>
Graduate an exploratory notebook that has received Critic PROCEED verdict into a validated Python script.

This command:
1. Validates notebook meets graduation requirements (seeds, parameters cell)
2. Confirms Critic PROCEED verdict exists for a run of this notebook
3. Converts notebook to Python script via nbconvert
4. Adds graduation metadata header from template
5. Places script in src/experiments/
6. Logs graduation to decision_log.md

**Requirements:**
- Notebook must have passing Critic PROCEED verdict (any confidence level)
- Notebook must meet graduation checklist (random seed set, parameters cell tagged)
- Original notebook stays in notebooks/exploration/ (not moved/deleted)
</objective>
```

**Arguments:**

```markdown
## Arguments

| Argument | Required | Description |
|----------|----------|-------------|
| `notebook_path` | Yes | Path to notebook in notebooks/exploration/ |
| `--run` | No | Specific run number that passed (auto-detect if omitted) |
| `--name` | No | Name for graduated script (default: notebook name) |
```

**Process section:**

```xml
<process>

## Step 1: Validate Arguments

1. Verify notebook_path exists and ends in .ipynb
2. Verify notebook is in notebooks/exploration/ (not arbitrary location)
3. Parse optional arguments

## Step 2: Find Passing Run

If --run specified:
- Verify experiments/run_{RUN}_*/CRITIC_LOG.md exists
- Verify verdict is PROCEED (any confidence)
- Verify run executed this notebook (check config.yaml source_notebook)

If --run not specified:
- Scan experiments/run_*/CRITIC_LOG.md for PROCEED verdicts
- Filter to runs that executed the specified notebook
- Use most recent passing run

**Error if no passing run found:**
"No PROCEED verdict found for {notebook_path}. Run /grd:research with this notebook first."

## Step 3: Run Graduation Validation

Spawn grd-graduator agent with:
- notebook_path
- run_dir (from Step 2)
- script_name (from --name or derived from notebook)

Agent will:
1. Validate graduation requirements
2. Convert notebook to script
3. Apply metadata template
4. Write to src/experiments/

## Step 4: Log Graduation

Update human_eval/decision_log.md with graduation entry:
| Date | Run | Decision | Rationale |
| {today} | run_NNN | GRADUATED | Notebook graduated to src/experiments/{script}.py |

## Step 5: Report Success

Display:
- Source notebook: {path}
- Validated run: run_{NNN}
- Graduated script: src/experiments/{name}.py
- Warnings (if any): {graduation warnings}
- Next steps: Review script, complete refactoring checklist, add tests

</process>
```

**Success criteria:**
```xml
<success_criteria>
- Graduated script exists in src/experiments/
- Script includes metadata header referencing source notebook
- Graduation logged in decision_log.md
- Original notebook unchanged in notebooks/exploration/
</success_criteria>
```
  </action>
  <verify>
Check command file exists: `ls commands/grd/graduate.md`
Check frontmatter valid: `head -10 commands/grd/graduate.md`
Check references grd-graduator: `grep "grd-graduator" commands/grd/graduate.md`
  </verify>
  <done>
- commands/grd/graduate.md created with proper frontmatter
- Command validates notebook path and finds passing run
- Command spawns grd-graduator agent
- Command logs graduation to decision_log.md
- Command reports success with next steps
  </done>
</task>

<task type="auto">
  <name>Task 2: Create grd-graduator agent</name>
  <files>agents/grd-graduator.md</files>
  <action>
Create the graduation agent following existing agent patterns (see agents/grd-researcher.md).

**YAML frontmatter:**
```yaml
---
name: grd-graduator
description: Converts validated notebooks to production Python scripts with graduation metadata
tools: Read, Write, Bash, Glob, Grep
color: cyan
---
```

**Role section:**
```xml
<role>
You are the GRD Graduator agent. Your job is to convert exploratory notebooks that have passed Critic validation into production-ready Python scripts.

**Core principle:** Graduation means conversion to script. Notebooks are for exploration, scripts are for production.

**Key behaviors:**
- Validate graduation requirements before converting
- Use nbconvert for base conversion
- Apply graduated-script template for metadata header
- Warn on style issues but don't block on them
- Guide user through manual refactoring checklist

**You create:**
- Graduated Python script in src/experiments/
- No changes to source notebook (stays in exploration/)
</role>
```

**Execution flow (6 steps):**

```markdown
## Step 1: Load Context

### 1.1 Parse Task Prompt

Extract from spawning prompt:
- notebook_path: Path to source notebook
- run_dir: Run directory that passed Critic
- script_name: Name for output script

### 1.2 Load Run Context

```bash
cat {run_dir}/CRITIC_LOG.md
```

Extract:
- Verdict: Must be PROCEED
- Verdict date
- Confidence level

```bash
cat {run_dir}/config.yaml
```

Extract parameters used in passing run.

## Step 2: Validate Graduation Requirements

### 2.1 Run Validation

Use graduation validator:

```python
from src.grd.graduation_validator import validate_graduation_requirements

result = validate_graduation_requirements(notebook_path)
```

### 2.2 Handle Results

**If result['passed'] == False:**
- List all errors
- Abort graduation: "Notebook does not meet graduation requirements"
- Suggest fixes: "Set random seed explicitly in notebook before graduating"

**If result['warnings']:**
- Display all warnings
- Continue with graduation (warnings are advisory)
- Include warnings in graduation report

## Step 3: Convert Notebook to Script

### 3.1 Run nbconvert

```bash
jupyter nbconvert --to script --output {temp_path} {notebook_path}
```

This creates a .py file with:
- Cell boundaries marked as comments
- Markdown cells as comment blocks
- Magic commands preserved (need manual removal)

### 3.2 Load Converted Script

```python
with open(temp_path) as f:
    converted_code = f.read()
```

## Step 4: Apply Graduation Template

### 4.1 Load Template

```bash
cat ~/.claude/get-research-done/templates/graduated-script.md
```

### 4.2 Fill Placeholders

Replace in template:
- `{{experiment_name}}`: From run_dir name or OBJECTIVE.md
- `{{source_notebook}}`: notebook_path
- `{{source_run}}`: run_dir
- `{{critic_verdict}}`: PROCEED
- `{{verdict_date}}`: From CRITIC_LOG.md
- `{{graduation_timestamp}}`: Current ISO 8601 timestamp

### 4.3 Combine Header and Code

```python
final_script = filled_template_header + "\n\n" + converted_code
```

## Step 5: Write Graduated Script

### 5.1 Determine Output Path

```python
output_path = Path(f"src/experiments/{script_name}.py")
```

### 5.2 Write Script

```python
with open(output_path, 'w') as f:
    f.write(final_script)
```

### 5.3 Verify Write

```bash
test -f src/experiments/{script_name}.py && echo "OK"
```

## Step 6: Report Completion

### 6.1 Summary

Report:
- Source notebook: {notebook_path}
- Validated run: {run_dir}
- Graduated script: src/experiments/{script_name}.py
- Lines converted: {line_count}
- Graduation warnings: {warnings_list or "None"}

### 6.2 Refactoring Guidance

Display:
```
MANUAL REFACTORING REQUIRED:
The graduated script needs manual cleanup before production use:

- [ ] Remove/convert magic commands (grep "^%" in script)
- [ ] Extract code into functions
- [ ] Replace parameter cell with argparse
- [ ] Add docstrings and type hints
- [ ] Verify all random seeds are set
- [ ] Write tests for core functions

See the script header for full checklist.
```

### 6.3 Return Success

Return:
- success: true
- output_path: src/experiments/{script_name}.py
- warnings: {warnings_list}
```
  </action>
  <verify>
Check agent file exists: `ls agents/grd-graduator.md`
Check has 6 steps: `grep -c "## Step" agents/grd-graduator.md`
Check references validator: `grep "validate_graduation_requirements" agents/grd-graduator.md`
Check references template: `grep "graduated-script" agents/grd-graduator.md`
  </verify>
  <done>
- agents/grd-graduator.md created with proper frontmatter
- Agent has 6-step workflow: load context, validate, convert, template, write, report
- Agent uses graduation_validator for requirement checking
- Agent uses nbconvert for base conversion
- Agent applies graduated-script template for metadata header
- Agent provides refactoring guidance in completion message
  </done>
</task>

</tasks>

<verification>
1. Command exists and has correct structure: `head -30 commands/grd/graduate.md`
2. Agent exists and has workflow: `grep "## Step" agents/grd-graduator.md`
3. Command spawns agent: `grep "grd-graduator" commands/grd/graduate.md`
4. Agent validates requirements: `grep "validate_graduation" agents/grd-graduator.md`
5. Agent references template: `grep "graduated-script" agents/grd-graduator.md`
</verification>

<success_criteria>
- /grd:graduate command created and validates PROCEED verdict
- grd-graduator agent created with 6-step workflow
- Agent validates graduation requirements before converting
- Agent converts via nbconvert and applies template
- Agent provides refactoring guidance
- Original notebook unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/06-notebook-support/06-04-SUMMARY.md`
</output>
