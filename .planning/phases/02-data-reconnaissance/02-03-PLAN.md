---
phase: 02-data-reconnaissance
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - agents/grd-explorer.md
autonomous: true

must_haves:
  truths:
    - "Explorer agent detects feature-target correlation leakage"
    - "Explorer agent detects train-test overlap using hash comparison"
    - "Explorer agent detects temporal leakage patterns"
    - "Explorer agent generates complete DATA_REPORT.md"
    - "Leakage warnings include confidence scores"
  artifacts:
    - path: "agents/grd-explorer.md"
      provides: "Leakage detection logic"
      contains: "correlation_leakage"
    - path: "agents/grd-explorer.md"
      provides: "Train-test overlap detection"
      contains: "hash_row"
    - path: "agents/grd-explorer.md"
      provides: "Report generation"
      contains: "DATA_REPORT.md"
  key_links:
    - from: "agents/grd-explorer.md"
      to: "get-research-done/templates/data-report.md"
      via: "Template population"
      pattern: "@.*data-report.md"
---

<objective>
Implement Explorer agent data leakage detection and report generation

Purpose: This plan completes the leakage detection and report generation portions of the Explorer agent. After this plan, the agent can detect potential data leakage (feature-target correlation, train-test overlap, temporal issues) and generate the complete DATA_REPORT.md file.

Output: Fully functional leakage detection and report generation in grd-explorer.md
</objective>

<execution_context>
@/Users/evanowen/.claude/get-research-done/workflows/execute-plan.md
@/Users/evanowen/.claude/get-research-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-reconnaissance/02-CONTEXT.md
@.planning/phases/02-data-reconnaissance/02-RESEARCH.md
@.planning/phases/02-data-reconnaissance/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement leakage detection logic</name>
  <files>agents/grd-explorer.md</files>
  <action>
Add comprehensive leakage detection logic to grd-explorer.md.

Based on CONTEXT.md decisions (comprehensive checks, confidence-based severity, warn only) and RESEARCH.md patterns:

1. **Feature-target correlation detection:**
   - Compute correlation matrix for numerical features
   - Flag features with |correlation| > 0.90 with target (from RESEARCH.md)
   - Include confidence score based on sample size and p-value
   - Pattern from RESEARCH.md Pattern 5:
   ```python
   def detect_correlation_leakage(df, target_col, threshold=0.90):
       corr_matrix = df.select_dtypes(include=[np.number]).corr()
       target_corrs = corr_matrix[target_col].drop(target_col).abs()
       high_corr = target_corrs[target_corrs > threshold]
       return high_corr.to_dict()
   ```

2. **High feature-feature correlations (proxy variables):**
   - Flag pairs with |correlation| > 0.95
   - Note: "Check if one is derived from the other"
   - Severity: HIGH if one column name suggests derivation

3. **Train-test overlap detection (if multiple files):**
   - Hash rows for efficient comparison
   - Exclude ID columns from hash (they should be unique)
   - Report overlap count and percentage
   - Severity: HIGH if overlap > 1% of test set
   - Pattern from RESEARCH.md Pattern 6:
   ```python
   def detect_train_test_overlap(train_df, test_df, exclude_cols=None):
       cols = [c for c in train_df.columns if c not in (exclude_cols or [])]
       def hash_row(row):
           return hashlib.md5(str(row.values).encode()).hexdigest()
       train_hashes = set(train_df[cols].apply(hash_row, axis=1))
       test_hashes = set(test_df[cols].apply(hash_row, axis=1))
       overlap = train_hashes & test_hashes
       return len(overlap), len(overlap)/len(test_df)*100
   ```

4. **Temporal leakage detection:**
   - Detect datetime columns (parse if string looks like date)
   - Check if test timestamps precede train timestamps
   - Flag potential future information leakage
   - Check for rolling/cumulative feature patterns in column names
   - Confidence: HIGH if explicit datetime, MEDIUM if inferred

5. **Derived feature detection:**
   - Look for column name patterns: *_ratio, *_diff, *_pct, *_avg
   - Flag as potential leakage if these correlate highly with target
   - Note: "Verify these features don't use target information"

6. **Confidence scoring:**
   - Each leakage warning gets a confidence score (HIGH/MEDIUM/LOW)
   - HIGH: Strong statistical evidence or definitive pattern
   - MEDIUM: Suggestive evidence, needs manual review
   - LOW: Possible issue, minimal evidence

**Important:** Leakage detection WARNS but does NOT block. User decides if warnings are actionable.
  </action>
  <verify>
    - `grep "correlation.*leakage\|detect_correlation" agents/grd-explorer.md` returns a match
    - `grep "train.*test.*overlap\|hash_row" agents/grd-explorer.md` returns a match
    - `grep "temporal.*leakage\|datetime" agents/grd-explorer.md` returns a match
    - `grep "confidence.*HIGH\|MEDIUM\|LOW" agents/grd-explorer.md` returns matches
  </verify>
  <done>
    Explorer agent has comprehensive leakage detection with confidence scores
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement report generation logic</name>
  <files>agents/grd-explorer.md</files>
  <action>
Add complete report generation logic to grd-explorer.md.

1. **Report generation step:**
   - Reference template: @get-research-done/templates/data-report.md
   - Populate all sections from analysis results
   - Write to .planning/DATA_REPORT.md

2. **Section population logic:**
   ```
   For each section in template:
     - Data Overview: rows, columns, memory, format
     - Column Summary: dtypes, non-null counts, unique counts
     - Distributions: numerical stats, categorical value counts
     - Missing Data: counts, patterns, MCAR/MAR/MNAR classification
     - Outliers: Z-score and IQR results, top anomalies
     - Class Balance: if target specified
     - Leakage Analysis: all detection results with confidence
     - Recommendations: tiered (must-address vs should-address)
   ```

3. **Recommendation generation:**
   - Must Address (Blocking): HIGH severity leakage, >50% missing critical columns
   - Should Address: MEDIUM severity issues, outliers affecting >5% of data
   - Notes: Observations, patterns noticed, suggestions for further investigation

4. **Multi-file handling:**
   - If multiple files analyzed (train/test/val):
     - Per-file sections first
     - Then comparison/drift section
     - Then train-test overlap section

5. **Adaptive depth:**
   - Summary mode (default): Basic stats, key issues only
   - Detailed mode (--detailed flag): Full histograms as text tables, all percentiles, skewness/kurtosis

6. **Report metadata:**
   - Timestamp: ISO format
   - Source files: Full paths
   - Sampling note: If sampled, note method and count
   - Agent version: GRD Explorer v1.0

7. **Output location:**
   - Write to: .planning/DATA_REPORT.md
   - Announce: "DATA_REPORT.md generated at .planning/DATA_REPORT.md"
  </action>
  <verify>
    - `grep "DATA_REPORT.md" agents/grd-explorer.md` returns multiple matches
    - `grep ".planning/DATA_REPORT" agents/grd-explorer.md` returns a match
    - `grep "Must Address\|Should Address\|Recommendations" agents/grd-explorer.md` returns matches
    - `grep "@.*data-report.md\|template" agents/grd-explorer.md` returns a match
  </verify>
  <done>
    Explorer agent generates complete DATA_REPORT.md with all sections
  </done>
</task>

</tasks>

<verification>
Run comprehensive verification:

```bash
echo "=== Verifying Explorer Agent Leakage Detection & Report Generation ==="

echo "1. Feature-target correlation detection:"
grep -E "correlation.*target|target.*corr" agents/grd-explorer.md | head -2

echo "2. Train-test overlap detection:"
grep -E "overlap|hash_row|train.*test" agents/grd-explorer.md | head -3

echo "3. Temporal leakage detection:"
grep -E "temporal|datetime|future.*leak" agents/grd-explorer.md | head -2

echo "4. Confidence scoring:"
grep -E "confidence.*score|HIGH.*MEDIUM.*LOW" agents/grd-explorer.md | head -2

echo "5. Report generation:"
grep -E "DATA_REPORT|\.planning/" agents/grd-explorer.md | head -3

echo "6. Recommendations:"
grep -E "Must Address|Should Address|recommendation" agents/grd-explorer.md | head -3

echo "7. Template reference:"
grep -E "data-report.md|template" agents/grd-explorer.md | head -2
```
</verification>

<success_criteria>
- Feature-target correlation detection with >0.90 threshold
- Feature-feature correlation detection with >0.95 threshold
- Train-test overlap detection using hash comparison
- Temporal leakage detection for datetime columns
- All warnings include confidence scores (HIGH/MEDIUM/LOW)
- Complete DATA_REPORT.md generation using template
- Tiered recommendations (must-address vs should-address)
- Output written to .planning/DATA_REPORT.md
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-reconnaissance/02-03-SUMMARY.md`
</output>
