---
phase: 05-human-evaluation-gate
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - commands/grd/evaluate.md
autonomous: true

must_haves:
  truths:
    - "Archive decision moves final run to experiments/archive/YYYY-MM-DD_hypothesis/"
    - "ARCHIVE_REASON.md is created with user's rationale"
    - "ITERATION_SUMMARY.md is generated collapsing all run history"
    - "Intermediate run directories are cleaned up"
    - "decision_log.md entry references archive location (not original path)"
  artifacts:
    - path: "commands/grd/evaluate.md"
      provides: "Complete archive handling implementation"
      contains: "experiments/archive"
  key_links:
    - from: "commands/grd/evaluate.md"
      to: "experiments/archive/"
      via: "creates archive directory structure"
      pattern: "experiments/archive"
    - from: "commands/grd/evaluate.md"
      to: "get-research-done/templates/archive-reason.md"
      via: "uses template for ARCHIVE_REASON.md"
      pattern: "archive-reason"
---

<objective>
Implement archive flow for negative results preservation with ARCHIVE_REASON.md and ITERATION_SUMMARY.md generation.

Purpose: Complete the Archive decision path by implementing the negative results preservation workflow. Per 05-CONTEXT.md decisions: archive to experiments/archive/, keep final run fully, collapse others into summary, use date-prefixed directories.

Output: Complete archive handling that preserves failed hypotheses with proper documentation for future researchers.
</objective>

<execution_context>
@/Users/evanowen/.claude/get-research-done/workflows/execute-plan.md
@/Users/evanowen/.claude/get-research-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-human-evaluation-gate/05-CONTEXT.md
@.planning/phases/05-human-evaluation-gate/05-RESEARCH.md
@.planning/phases/05-human-evaluation-gate/05-02-SUMMARY.md
@.planning/phases/05-human-evaluation-gate/05-03-SUMMARY.md
@get-research-done/templates/archive-reason.md
@get-research-done/templates/iteration-summary.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement archive directory creation</name>
  <files>commands/grd/evaluate.md</files>
  <action>
Replace Phase 5 placeholder in /grd:evaluate with complete archive handling.

**Archive directory structure (from 05-CONTEXT.md):**

```
experiments/archive/YYYY-MM-DD_hypothesis_name/
├── ARCHIVE_REASON.md         # Why hypothesis failed (user rationale)
├── ITERATION_SUMMARY.md      # Collapsed history of all attempts
├── run_NNN_final/            # Final run preserved fully
│   ├── code/
│   ├── config.yaml
│   ├── data/
│   ├── logs/
│   ├── outputs/
│   ├── metrics/
│   ├── README.md
│   ├── CRITIC_LOG.md
│   └── DECISION.md
└── metadata.json             # Archival metadata
```

**Step 1: Determine archive path**

```bash
# Extract hypothesis name from OBJECTIVE.md (sanitize for filesystem)
HYPOTHESIS_RAW=$(grep -A 1 "## Hypothesis" .planning/OBJECTIVE.md | tail -1 | head -c 50)
HYPOTHESIS_NAME=$(echo "$HYPOTHESIS_RAW" | tr ' ' '_' | tr -cd '[:alnum:]_-' | tr '[:upper:]' '[:lower:]')

# Date prefix
DATE_PREFIX=$(date +%Y-%m-%d)

# Archive directory path
ARCHIVE_DIR="experiments/archive/${DATE_PREFIX}_${HYPOTHESIS_NAME}"

# Create archive directory
mkdir -p "$ARCHIVE_DIR"
```

**Step 2: Identify final and intermediate runs**

```bash
# Find all run directories
ALL_RUNS=$(ls -d experiments/run_* 2>/dev/null | sort)

# Final run is the current one being evaluated
FINAL_RUN="experiments/$RUN_NAME"

# Intermediate runs are all others
INTERMEDIATE_RUNS=$(echo "$ALL_RUNS" | grep -v "$RUN_NAME")
```

**Step 3: Move final run to archive**

```bash
# Move final run directory to archive
mv "$FINAL_RUN" "$ARCHIVE_DIR/run_final"

# Verify move succeeded
test -d "$ARCHIVE_DIR/run_final" || echo "ERROR: Failed to move final run"
```

Display progress:
```
Moving final run to archive...
  From: experiments/$RUN_NAME/
  To: $ARCHIVE_DIR/run_final/
```
  </action>
  <verify>
```bash
grep -q "experiments/archive" commands/grd/evaluate.md && grep -q "DATE_PREFIX" commands/grd/evaluate.md && grep -q "mkdir.*archive" commands/grd/evaluate.md && echo "Archive directory creation implemented"
```
  </verify>
  <done>
Archive directory creation implemented: determines hypothesis name from OBJECTIVE.md, creates date-prefixed directory, identifies final vs intermediate runs, moves final run to archive with preserved structure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement ARCHIVE_REASON.md and ITERATION_SUMMARY.md generation</name>
  <files>commands/grd/evaluate.md</files>
  <action>
Continue archive handling with document generation.

**Step 4: Generate ARCHIVE_REASON.md**

Use template from get-research-done/templates/archive-reason.md:

```bash
# Create ARCHIVE_REASON.md from template
cat > "$ARCHIVE_DIR/ARCHIVE_REASON.md" << EOF
# Archive Reason: $HYPOTHESIS_NAME

**Archived:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")
**Original Hypothesis:** $HYPOTHESIS_STATEMENT
**Final Iteration:** $ITERATION_COUNT of $ITERATION_LIMIT
**Final Verdict:** $FINAL_VERDICT

## Why This Failed

$USER_RATIONALE

## What We Learned

*To be filled: Insights from failed attempts*

-

## What Would Need to Change

*To be filled: Conditions under which this might work*

-

## Final Metrics

| Metric | Best Value | Target | Gap |
|--------|------------|--------|-----|
$BEST_METRICS_TABLE

## Iteration Timeline

See: ITERATION_SUMMARY.md for detailed history of all attempts.

---

*This negative result is preserved to prevent future researchers from repeating this approach without the necessary conditions.*
EOF
```

User rationale is REQUIRED (captured in 05-02 decision gate).

**Step 5: Generate ITERATION_SUMMARY.md**

Scan all run directories and compile history:

```bash
# Build iteration history table
HISTORY_TABLE=""
for run_dir in $ALL_RUNS; do
  run_name=$(basename "$run_dir")
  # Extract data from each run's CRITIC_LOG.md and SCORECARD.json
  if [ -f "$run_dir/CRITIC_LOG.md" ]; then
    verdict=$(grep "^\*\*Verdict:\*\*" "$run_dir/CRITIC_LOG.md" | head -1 | sed 's/\*\*Verdict:\*\* //')
    confidence=$(grep "^\*\*Confidence:\*\*" "$run_dir/CRITIC_LOG.md" | head -1 | sed 's/\*\*Confidence:\*\* //')
  fi
  if [ -f "$run_dir/metrics/SCORECARD.json" ]; then
    # Extract key metric from SCORECARD.json
    key_metric=$(cat "$run_dir/metrics/SCORECARD.json" | grep -o '"[a-zA-Z_]*": [0-9.]*' | head -1)
  fi
  run_date=$(stat -f "%Sm" -t "%Y-%m-%d" "$run_dir" 2>/dev/null || date +%Y-%m-%d)

  HISTORY_TABLE="$HISTORY_TABLE
| $iteration | $run_name | $run_date | $verdict | $confidence | $key_metric | |"
done

# Calculate metric trend
# Compare first and last key metric values

# Count verdicts
PROCEED_COUNT=$(echo "$HISTORY_TABLE" | grep -c "PROCEED" || echo 0)
REVISE_METHOD_COUNT=$(echo "$HISTORY_TABLE" | grep -c "REVISE_METHOD" || echo 0)
REVISE_DATA_COUNT=$(echo "$HISTORY_TABLE" | grep -c "REVISE_DATA" || echo 0)
ESCALATE_COUNT=$(echo "$HISTORY_TABLE" | grep -c "ESCALATE" || echo 0)

# Write ITERATION_SUMMARY.md
cat > "$ARCHIVE_DIR/ITERATION_SUMMARY.md" << EOF
# Iteration Summary: $HYPOTHESIS_NAME

**Total Iterations:** $TOTAL_ITERATIONS
**Date Range:** $FIRST_DATE to $LAST_DATE
**Outcome:** Archived (hypothesis abandoned)

## Iteration History

| # | Run | Date | Verdict | Confidence | Key Metric | Notes |
|---|-----|------|---------|------------|------------|-------|
$HISTORY_TABLE

## Metric Trend

**Best achieved:** $BEST_METRIC
**Target:** $TARGET_THRESHOLD
**Gap:** $GAP
**Trend:** $TREND

## Verdict Distribution

- PROCEED: $PROCEED_COUNT
- REVISE_METHOD: $REVISE_METHOD_COUNT
- REVISE_DATA: $REVISE_DATA_COUNT
- ESCALATE: $ESCALATE_COUNT

## Key Observations

*Summary of what was tried and why it didn't work*

## Preserved Artifacts

- Final run: run_final/
- All CRITIC_LOG.md files preserved in final run
- Final SCORECARD.json preserved in final run

---

*Summary generated on archive. See ARCHIVE_REASON.md for human rationale.*
EOF
```
  </action>
  <verify>
```bash
grep -q "ARCHIVE_REASON.md" commands/grd/evaluate.md && grep -q "ITERATION_SUMMARY.md" commands/grd/evaluate.md && grep -q "USER_RATIONALE" commands/grd/evaluate.md && echo "Document generation implemented"
```
  </verify>
  <done>
ARCHIVE_REASON.md generation implemented using template with user rationale, final metrics, and placeholder sections. ITERATION_SUMMARY.md generation implemented with history table compiled from all runs, metric trend analysis, and verdict distribution.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement cleanup and archive completion</name>
  <files>commands/grd/evaluate.md</files>
  <action>
Complete archive flow with cleanup and confirmation.

**Step 6: Create metadata.json**

```bash
# Create archival metadata
cat > "$ARCHIVE_DIR/metadata.json" << EOF
{
  "archived_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "hypothesis": "$HYPOTHESIS_STATEMENT",
  "total_iterations": $TOTAL_ITERATIONS,
  "final_verdict": "$FINAL_VERDICT",
  "best_metric": "$BEST_METRIC",
  "target_threshold": "$TARGET_THRESHOLD",
  "archive_reason": "User decision: $USER_RATIONALE_FIRST_LINE",
  "intermediate_runs_removed": $INTERMEDIATE_COUNT,
  "final_run_preserved": "run_final"
}
EOF
```

**Step 7: Clean up intermediate runs**

```bash
# Remove intermediate run directories (final run already moved)
for run_dir in $INTERMEDIATE_RUNS; do
  if [ -d "$run_dir" ]; then
    # Optionally: zip before removing if --archive-all flag
    rm -rf "$run_dir"
    echo "Removed: $run_dir"
  fi
done
```

Display progress:
```
Cleaning up intermediate runs...
  Removed: experiments/run_001_baseline/
  Removed: experiments/run_002_tuned/
  Kept: Final run preserved in archive
```

**Step 8: Update decision_log.md reference**

The decision log entry should point to archive location, not original:

```bash
# Update last entry in decision_log.md to point to archive
# Change: experiments/run_003_tuned/ -> experiments/archive/2026-01-30_hypothesis/
sed -i "s|experiments/$RUN_NAME/|$ARCHIVE_DIR/|" human_eval/decision_log.md
```

**Step 9: Display archive completion**

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 GRD ► HYPOTHESIS ARCHIVED
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**Archive Location:** $ARCHIVE_DIR

**Contents:**
- ARCHIVE_REASON.md — Your rationale preserved
- ITERATION_SUMMARY.md — All $TOTAL_ITERATIONS attempts summarized
- run_final/ — Final run with all artifacts
- metadata.json — Archival metadata

**Cleanup:**
- $INTERMEDIATE_COUNT intermediate runs removed
- Final run preserved with full artifacts

**Next steps:**
- Review ARCHIVE_REASON.md to add learnings
- Optionally fill "What We Learned" and "What Would Need to Change" sections
- Start new hypothesis with /grd:architect if ready

This negative result is preserved for future reference.
```
  </action>
  <verify>
```bash
grep -q "metadata.json" commands/grd/evaluate.md && grep -q "rm -rf" commands/grd/evaluate.md && grep -q "HYPOTHESIS ARCHIVED" commands/grd/evaluate.md && echo "Cleanup and completion implemented"
```
  </verify>
  <done>
Archive completion implemented: creates metadata.json with archival context, removes intermediate run directories, updates decision_log.md reference to archive location, displays comprehensive archive completion message with contents and next steps.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

```bash
# Verify archive directory creation
grep -q "ARCHIVE_DIR" commands/grd/evaluate.md && grep -q "mkdir.*archive" commands/grd/evaluate.md && echo "Archive directory creation present"

# Verify document generation
grep -q "ARCHIVE_REASON.md" commands/grd/evaluate.md && grep -q "ITERATION_SUMMARY.md" commands/grd/evaluate.md && echo "Document generation present"

# Verify cleanup
grep -q "rm -rf" commands/grd/evaluate.md && echo "Cleanup logic present"

# Verify metadata
grep -q "metadata.json" commands/grd/evaluate.md && echo "Metadata creation present"

# Verify completion message
grep -q "HYPOTHESIS ARCHIVED" commands/grd/evaluate.md && echo "Completion message present"
```

Expected: Complete archive flow with directory creation, document generation, cleanup, and confirmation.
</verification>

<success_criteria>
- [ ] Archive directory created with date-prefix and hypothesis name
- [ ] Final run moved to archive as run_final/
- [ ] ARCHIVE_REASON.md created with user's required rationale
- [ ] ITERATION_SUMMARY.md generated with history from all runs
- [ ] metadata.json created with archival context
- [ ] Intermediate run directories removed
- [ ] decision_log.md entry updated to point to archive
- [ ] Completion message shows archive contents and next steps
</success_criteria>

<output>
After completion, create `.planning/phases/05-human-evaluation-gate/05-04-SUMMARY.md`
</output>
